<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä»Šå¤©åƒä»€ä¹ˆ - æˆ‘çš„å†å²è®°å½•</title>
<style>
:root {
  --primary: #e67e22;
  --primary-dark: #d35400;
  --bg: #faf7f2;
  --card: #ffffff;
  --text: #333333;
  --text-light: #7f8c8d;
  --success: #27ae60;
  --error: #e74c3c;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  --radius: 12px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 800px;
  margin: 0 auto;
}

.header {
  text-align: center;
  margin-bottom: 30px;
  padding-top: 20px;
}

.header h1 {
  color: var(--primary);
  font-size: 2.5rem;
  margin-bottom: 10px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.header p {
  color: var(--text-light);
  font-size: 1.1rem;
}

.controls {
  background: white;
  padding: 20px;
  border-radius: var(--radius);
  margin-bottom: 30px;
  box-shadow: var(--shadow);
  border: 2px solid rgba(230, 126, 34, 0.2);
}

.controls-title {
  font-size: 1.2rem;
  color: #2c3e50;
  margin-bottom: 15px;
  font-weight: 600;
}

.controls-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.primary-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 12px 24px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border: none;
  border-radius: var(--radius);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(230, 126, 34, 0.3);
}

.primary-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 28px rgba(230, 126, 34, 0.4);
}

.secondary-btn {
  padding: 12px 24px;
  background: transparent;
  color: var(--primary);
  border: 2px solid var(--primary);
  border-radius: var(--radius);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.secondary-btn:hover {
  background: rgba(230, 126, 34, 0.1);
}

.history-stats {
  display: flex;
  gap: 15px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.stat-box {
  flex: 1;
  min-width: 150px;
  background: #f9f9f9;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  border: 1px solid #eee;
}

.stat-number {
  font-size: 1.8rem;
  font-weight: bold;
  color: var(--primary);
  display: block;
}

.selection-list {
  display: grid;
  gap: 20px;
  margin-bottom: 40px;
}

.selection-card {
  background: white;
  border-radius: var(--radius);
  padding: 25px;
  box-shadow: var(--shadow);
  border-left: 5px solid var(--primary);
  transition: transform 0.3s ease;
  position: relative;
}

.selection-card:hover {
  transform: translateY(-5px);
}

.time-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 2px solid #f0f0f0;
}

.selection-time {
  font-weight: bold;
  font-size: 1.1rem;
  color: #2c3e50;
}

.timestamp {
  color: var(--text-light);
  font-size: 0.9rem;
}

.dishes-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 15px;
}

.dish-tag {
  background: #fff9f0;
  color: var(--primary);
  padding: 8px 15px;
  border-radius: 20px;
  font-weight: 500;
  border: 1px solid #ffecc7;
}

.selection-count {
  font-weight: bold;
  color: var(--primary);
  font-size: 1.1rem;
}

.delete-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  background: #ff6b6b;
  color: white;
  border: none;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.delete-btn:hover {
  background: #ff5252;
  transform: scale(1.1);
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-light);
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

.empty-state h3 {
  color: var(--text-light);
  margin-bottom: 15px;
  font-size: 1.3rem;
}

.loading {
  text-align: center;
  padding: 60px 20px;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.back-link {
  display: inline-block;
  color: var(--primary);
  text-decoration: none;
  font-weight: 500;
  font-size: 1rem;
  padding: 10px 20px;
  border: 2px solid var(--primary);
  border-radius: 25px;
  transition: all 0.3s ease;
  margin-top: 15px;
  text-align: center;
}

.back-link:hover {
  background: rgba(230, 126, 34, 0.1);
}

@media (max-width: 480px) {
  .header h1 {
    font-size: 2rem;
  }
  
  .controls-buttons {
    flex-direction: column;
  }
  
  .history-stats {
    flex-direction: column;
  }
  
  .time-info {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ“‹ æˆ‘çš„å†å²è®°å½•</h1>
    <p>æŸ¥çœ‹å’Œåˆ é™¤ä½ ä¹‹å‰çš„é€‰æ‹©è®°å½•</p>
  </div>

  <div class="controls">
    <div class="controls-title">æ“ä½œ</div>
    <div class="controls-buttons">
      <button class="primary-btn" id="refreshBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
          <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
        </svg>
        åˆ·æ–°è®°å½•
      </button>
      <button class="secondary-btn" id="clearAllBtn">æ¸…ç©ºæˆ‘çš„è®°å½•</button>
      <a href="/" class="secondary-btn" style="text-decoration: none; text-align: center;">è¿”å›é€‰æ‹©é¡µé¢</a>
    </div>
    
    <div class="history-stats" id="historyStats">
      <!-- ç»Ÿè®¡æ•°æ®ä¼šåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <p>æ­£åœ¨åŠ è½½å†å²è®°å½•...</p>
  </div>

  <div class="selection-list" id="selectionList">
    <!-- å†å²è®°å½•ä¼šåŠ¨æ€ç”Ÿæˆ -->
  </div>

  <div style="text-align: center;">
    <a href="/" class="back-link">è¿”å›é€‰æ‹©é¡µé¢</a>
  </div>
</div>

<script>
// ==================== é…ç½® ====================
const SUPABASE_URL = 'https://ä½ çš„é¡¹ç›®ID.supabase.co';  // æ›¿æ¢ä¸ºä½ çš„ Supabase URL
const SUPABASE_KEY = 'ä½ çš„anon/public key';  // æ›¿æ¢ä¸ºä½ çš„ Supabase anon key

// ==================== DOM å…ƒç´  ====================
const loading = document.getElementById('loading');
const selectionList = document.getElementById('selectionList');
const refreshBtn = document.getElementById('refreshBtn');
const clearAllBtn = document.getElementById('clearAllBtn');
const historyStats = document.getElementById('historyStats');

// è·å–è®¾å¤‡IDï¼ˆä¸index.htmlä¸­ç›¸åŒï¼‰
function getDeviceId() {
  let deviceId = localStorage.getItem('foodChooserDeviceId');
  if (!deviceId) {
    deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('foodChooserDeviceId', deviceId);
  }
  return deviceId;
}

// ==================== åŠ è½½å½“å‰è®¾å¤‡çš„å†å²è®°å½• ====================
async function loadHistory() {
  try {
    loading.style.display = 'block';
    selectionList.innerHTML = '';
    
    const deviceId = getDeviceId();
    console.log('å½“å‰è®¾å¤‡ID:', deviceId);
    console.log('æ­£åœ¨åŠ è½½è®¾å¤‡å†å²è®°å½•...');
    
    // åªæŸ¥è¯¢å½“å‰è®¾å¤‡çš„é€‰æ‹©è®°å½•
    const response = await fetch(`${SUPABASE_URL}/rest/v1/selections?device_id=eq.${encodeURIComponent(deviceId)}&order=created_at.desc`, {
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json'
      }
    });
    
    console.log('å“åº”çŠ¶æ€:', response.status);
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`è·å–æ•°æ®å¤±è´¥ (${response.status}): ${errorText}`);
    }
    
    const selections = await response.json();
    console.log('è·å–åˆ°çš„æ•°æ®:', selections);
    
    if (!selections || selections.length === 0) {
      selectionList.innerHTML = `
        <div class="empty-state">
          <h3>ğŸ“­ è¿˜æ²¡æœ‰ä»»ä½•å†å²è®°å½•</h3>
          <p>å»é€‰æ‹©é¡µé¢é€‰æ‹©èœå“å¹¶æäº¤ï¼Œè¿™é‡Œå°±ä¼šæ˜¾ç¤ºä½ çš„è®°å½•äº†</p>
          <a href="/" class="back-link" style="margin-top: 20px;">å»é€‰æ‹©èœå“</a>
        </div>
      `;
      updateStats(0, 0);
      loading.style.display = 'none';
      return;
    }
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    updateStats(selections.length, selections.reduce((sum, s) => sum + s.dishes.length, 0));
    
    // æ˜¾ç¤ºå½“å‰è®¾å¤‡çš„å†å²è®°å½•
    selections.forEach((selection, index) => {
      // æ ¼å¼åŒ–æ—¶é—´
      const time = selection.submit_time || 
        new Date(selection.created_at).toLocaleString('zh-CN', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      
      const card = document.createElement('div');
      card.className = 'selection-card';
      card.innerHTML = `
        <div class="time-info">
          <div class="selection-time">é€‰æ‹©è®°å½• #${selections.length - index}</div>
          <div class="timestamp">${time}</div>
        </div>
        
        <div class="dishes-list">
          ${selection.dishes.map(dish => 
            `<span class="dish-tag">${dish.name}${dish.category ? ` (${dish.category})` : ''}</span>`
          ).join('')}
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>æ€»è®¡ï¼š<span class="selection-count">${selection.dishes.length}</span> ä¸ªèœå“</strong>
          </div>
          <button class="delete-btn" onclick="deleteHistorySelection('${selection.id}')" title="åˆ é™¤è¿™æ¡è®°å½•">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
              <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
            </svg>
          </button>
        </div>
      `;
      
      selectionList.appendChild(card);
    });
    
  } catch (error) {
    console.error('åŠ è½½å¤±è´¥:', error);
    selectionList.innerHTML = `
      <div class="error" style="background: #fdedec; padding: 30px; border-radius: 10px; text-align: center;">
        <h3 style="color: #e74c3c;">âŒ åŠ è½½å¤±è´¥</h3>
        <p>${error.message}</p>
        <p style="margin-top: 10px; font-size: 0.9rem;">è¯·æ£€æŸ¥Supabaseé…ç½®å’Œç½‘ç»œè¿æ¥</p>
        <button class="secondary-btn" onclick="loadHistory()" style="margin-top: 15px;">é‡æ–°åŠ è½½</button>
      </div>
    `;
  } finally {
    loading.style.display = 'none';
  }
}

// æ›´æ–°ç»Ÿè®¡æ•°æ®
function updateStats(totalSelections, totalDishes) {
  historyStats.innerHTML = `
    <div class="stat-box">
      <span class="stat-number">${totalSelections}</span>
      <span>æ€»é€‰æ‹©æ¬¡æ•°</span>
    </div>
    <div class="stat-box">
      <span class="stat-number">${totalDishes}</span>
      <span>æ€»èœå“æ•°é‡</span>
    </div>
    <div class="stat-box">
      <span class="stat-number">${totalSelections > 0 ? Math.round(totalDishes / totalSelections) : 0}</span>
      <span>å¹³å‡æ¯å•èœå“æ•°</span>
    </div>
  `;
}

// åˆ é™¤å•æ¡è®°å½•
async function deleteHistorySelection(id) {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/selections?id=eq.${id}`, {
        method: 'DELETE',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Prefer': 'return=minimal'
        }
      });
      
      if (response.ok) {
        showToast('åˆ é™¤æˆåŠŸ');
        loadHistory(); // é‡æ–°åŠ è½½
      } else {
        const errorText = await response.text();
        throw new Error(`åˆ é™¤å¤±è´¥: ${errorText}`);
      }
      
    } catch (error) {
      console.error('åˆ é™¤å¤±è´¥:', error);
      showToast('åˆ é™¤å¤±è´¥: ' + error.message);
    }
  }
}

// æ¸…ç©ºå½“å‰è®¾å¤‡çš„æ‰€æœ‰è®°å½•
async function clearAllHistory() {
  if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºä½ çš„æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
    try {
      const deviceId = getDeviceId();
      const response = await fetch(`${SUPABASE_URL}/rest/v1/selections?device_id=eq.${encodeURIComponent(deviceId)}`, {
        method: 'DELETE',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Prefer': 'return=minimal'
        }
      });
      
      if (response.ok) {
        showToast('ä½ çš„æ‰€æœ‰è®°å½•å·²æ¸…ç©º');
        loadHistory();
      } else {
        const errorText = await response.text();
        throw new Error(`æ¸…ç©ºå¤±è´¥: ${errorText}`);
      }
      
    } catch (error) {
      console.error('æ¸…ç©ºå¤±è´¥:', error);
      showToast('æ¸…ç©ºå¤±è´¥: ' + error.message);
    }
  }
}

// æ˜¾ç¤ºæç¤º
function showToast(message) {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${message.includes('å¤±è´¥') ? '#e74c3c' : '#27ae60'};
    color: white;
    padding: 12px 25px;
    border-radius: 8px;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ==================== äº‹ä»¶ç›‘å¬ ====================
refreshBtn.addEventListener('click', loadHistory);
clearAllBtn.addEventListener('click', clearAllHistory);

// ==================== åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', loadHistory);
</script>
</body>
</html>
