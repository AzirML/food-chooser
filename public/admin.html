<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä»Šå¤©åƒä»€ä¹ˆ - åå°æŸ¥çœ‹</title>
<style>
:root {
  --primary: #e67e22;
  --primary-dark: #d35400;
  --bg: #faf7f2;
  --card: #ffffff;
  --text: #333333;
  --text-light: #7f8c8d;
  --success: #27ae60;
  --error: #e74c3c;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  --radius: 12px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 20px;
}

.container {
  max-width: 1000px;
  margin: 0 auto;
}

.header {
  text-align: center;
  padding: 30px 0;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  border-radius: 15px;
  color: white;
  margin-bottom: 30px;
}

.header h1 {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

.header p {
  font-size: 1.1rem;
  opacity: 0.9;
}

.controls {
  background: white;
  padding: 20px;
  border-radius: var(--radius);
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  border: 2px solid rgba(230, 126, 34, 0.2);
}

.refresh-btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 8px;
  font-size: 1.1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: all 0.3s ease;
}

.refresh-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(230, 126, 34, 0.3);
}

.stats {
  display: flex;
  gap: 20px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.stat-box {
  flex: 1;
  min-width: 150px;
  background: #f9f9f9;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  border: 1px solid #eee;
}

.stat-number {
  font-size: 2rem;
  font-weight: bold;
  color: var(--primary);
  display: block;
}

.selection-list {
  display: grid;
  gap: 20px;
}

.selection-card {
  background: white;
  border-radius: var(--radius);
  padding: 25px;
  box-shadow: var(--shadow);
  border-left: 5px solid var(--primary);
  transition: transform 0.3s ease;
  position: relative;
}

.selection-card:hover {
  transform: translateY(-5px);
}

.user-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 2px solid #f0f0f0;
}

.user-name {
  font-weight: bold;
  font-size: 1.2rem;
  color: #2c3e50;
}

.submit-time {
  color: var(--text-light);
  font-size: 0.9rem;
}

.dishes-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 15px;
}

.dish-tag {
  background: #fff9f0;
  color: var(--primary);
  padding: 8px 15px;
  border-radius: 20px;
  font-weight: 500;
  border: 1px solid #ffecc7;
}

.selection-count {
  font-weight: bold;
  color: var(--primary);
  font-size: 1.2rem;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-light);
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

.loading {
  text-align: center;
  padding: 40px;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.delete-btn {
  background: #ff6b6b;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.9rem;
  margin-top: 10px;
  transition: background 0.3s ease;
}

.delete-btn:hover {
  background: #ff5252;
}

.export-btn {
  background: #3498db;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.9rem;
  margin-left: 10px;
}

.export-btn:hover {
  background: #2980b9;
}

.clear-btn {
  background: #95a5a6;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.9rem;
  margin-left: 10px;
}

.clear-btn:hover {
  background: #7f8c8d;
}

.action-buttons {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.back-link {
  display: inline-block;
  color: var(--primary);
  text-decoration: none;
  font-weight: 500;
  font-size: 1rem;
  padding: 10px 20px;
  border: 2px solid var(--primary);
  border-radius: 25px;
  transition: all 0.3s ease;
  margin-top: 15px;
  text-align: center;
}

.back-link:hover {
  background: rgba(230, 126, 34, 0.1);
}

.device-stats {
  margin-top: 15px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #3498db;
}

.device-stats h4 {
  margin: 0 0 10px 0;
  color: #2c3e50;
}

@media (max-width: 768px) {
  .stats {
    flex-direction: column;
  }
  
  .stat-box {
    min-width: 100%;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .action-buttons button {
    width: 100%;
    margin-left: 0 !important;
    margin-top: 10px;
  }
  
  .user-info {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ½ï¸ ä»Šå¤©åƒä»€ä¹ˆ - åå°æŸ¥çœ‹</h1>
    <p>æ‰€æœ‰è®¾å¤‡æäº¤çš„èœå“é€‰æ‹©éƒ½åœ¨è¿™é‡Œ</p>
  </div>

  <div class="controls">
    <button class="refresh-btn" id="refreshBtn">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
      </svg>
      åˆ·æ–°æ•°æ®
    </button>
    
    <div class="action-buttons">
      <button class="export-btn" id="exportBtn">å¯¼å‡ºæ•°æ®</button>
      <button class="clear-btn" id="clearAllBtn">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
      <a href="/" class="back-link" style="text-decoration: none; text-align: center;">è¿”å›é€‰æ‹©é¡µé¢</a>
    </div>
    
    <div class="stats" id="stats">
      <!-- ç»Ÿè®¡æ•°æ®ä¼šåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <div class="device-stats" id="deviceStats">
      <h4>ğŸ“± è®¾å¤‡ç»Ÿè®¡</h4>
      <p>ä¸åŒè®¾å¤‡æ•°é‡ï¼š<span id="deviceCount">0</span></p>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
  </div>

  <div class="selection-list" id="selectionList">
    <!-- é€‰æ‹©è®°å½•ä¼šåŠ¨æ€ç”Ÿæˆ -->
  </div>

  <div style="text-align: center; margin-top: 30px;">
    <a href="/" class="back-link">è¿”å›é€‰æ‹©é¡µé¢</a>
  </div>
</div>

<script>
// ==================== é…ç½® ====================
const SUPABASE_URL = 'https://iyisisxptqoaiqprwprx.supabase.co';  // æ›¿æ¢ä¸ºä½ çš„ Supabase URL
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aXNpc3hwdHFvYWlxcHJ3cHJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODUxNzAsImV4cCI6MjA4MzE2MTE3MH0.NuQYUuKHN7BLtteoxbneBM_RHGvkASvz-HgG0c_ndeI';  // æ›¿æ¢ä¸ºä½ çš„ Supabase anon key

// ==================== DOM å…ƒç´  ====================
const loading = document.getElementById('loading');
const selectionList = document.getElementById('selectionList');
const refreshBtn = document.getElementById('refreshBtn');
const stats = document.getElementById('stats');
const exportBtn = document.getElementById('exportBtn');
const clearAllBtn = document.getElementById('clearAllBtn');
const deviceStats = document.getElementById('deviceStats');
const deviceCount = document.getElementById('deviceCount');

// ==================== åŠ è½½æ‰€æœ‰é€‰æ‹©è®°å½• ====================
async function loadSelections() {
  try {
    loading.style.display = 'block';
    selectionList.innerHTML = '';
    
    console.log('å¼€å§‹åŠ è½½æ•°æ®...');
    
    // ä» Supabase è·å–æ•°æ®ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´é™åºæ’åˆ—
    const response = await fetch(`${SUPABASE_URL}/rest/v1/selections?select=*&order=created_at.desc`, {
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json'
      }
    });
    
    console.log('å“åº”çŠ¶æ€:', response.status);
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`è·å–æ•°æ®å¤±è´¥ (${response.status}): ${errorText}`);
    }
    
    const selections = await response.json();
    console.log('è·å–åˆ°çš„æ•°æ®:', selections);
    
    if (!selections || selections.length === 0) {
      selectionList.innerHTML = `
        <div class="empty-state">
          <h3>ğŸ“­ è¿˜æ²¡æœ‰ä»»ä½•æäº¤</h3>
          <p>ç­‰å¾…ç”¨æˆ·æäº¤é€‰æ‹©...</p>
        </div>
      `;
      updateStats(0, 0, 0);
      loading.style.display = 'none';
      return;
    }
    
    // è®¡ç®—ä¸åŒè®¾å¤‡æ•°é‡
    const deviceSet = new Set();
    selections.forEach(selection => {
      if (selection.device_id) {
        deviceSet.add(selection.device_id);
      }
    });
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    updateStats(selections.length, selections.reduce((sum, s) => sum + s.dishes.length, 0), deviceSet.size);
    
    // æ˜¾ç¤ºæ‰€æœ‰é€‰æ‹©
    selections.forEach((selection, index) => {
      const deviceName = selection.device_id ? 
        `è®¾å¤‡: ${selection.device_id.substring(0, 12)}...` : 
        'æœªçŸ¥è®¾å¤‡';
      
      // æ ¼å¼åŒ–æ—¶é—´
      const time = selection.submit_time || 
        new Date(selection.created_at).toLocaleString('zh-CN', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      
      const card = document.createElement('div');
      card.className = 'selection-card';
      card.innerHTML = `
        <div class="user-info">
          <div class="user-name">${deviceName}</div>
          <div class="submit-time">ğŸ• ${time}</div>
        </div>
        
        <div class="dishes-list">
          ${selection.dishes.map(dish => 
            `<span class="dish-tag">${dish.name}${dish.category ? ` (${dish.category})` : ''}</span>`
          ).join('')}
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>æ€»è®¡ï¼š<span class="selection-count">${selection.dishes.length}</span> ä¸ªèœå“</strong>
          </div>
          <button class="delete-btn" onclick="deleteSelection('${selection.id}')">åˆ é™¤è¿™æ¡è®°å½•</button>
        </div>
      `;
      
      selectionList.appendChild(card);
    });
    
  } catch (error) {
    console.error('åŠ è½½å¤±è´¥:', error);
    selectionList.innerHTML = `
      <div class="error" style="background: #fdedec; padding: 30px; border-radius: 10px; text-align: center;">
        <h3 style="color: #e74c3c;">âŒ åŠ è½½å¤±è´¥</h3>
        <p>${error.message}</p>
        <p style="margin-top: 10px; font-size: 0.9rem;">è¯·æ£€æŸ¥Supabaseé…ç½®å’Œç½‘ç»œè¿æ¥</p>
        <button class="delete-btn" onclick="loadSelections()" style="margin-top: 15px; background: #3498db;">é‡æ–°åŠ è½½</button>
      </div>
    `;
  } finally {
    loading.style.display = 'none';
  }
}

// æ›´æ–°ç»Ÿè®¡æ•°æ®
function updateStats(totalSelections, totalDishes, totalDevices) {
  stats.innerHTML = `
    <div class="stat-box">
      <span class="stat-number">${totalSelections}</span>
      <span>æ€»é€‰æ‹©æ¬¡æ•°</span>
    </div>
    <div class="stat-box">
      <span class="stat-number">${totalDishes}</span>
      <span>æ€»èœå“æ•°é‡</span>
    </div>
    <div class="stat-box">
      <span class="stat-number">${totalSelections > 0 ? Math.round(totalDishes / totalSelections) : 0}</span>
      <span>å¹³å‡æ¯å•èœå“æ•°</span>
    </div>
  `;
  
  deviceCount.textContent = totalDevices;
}

// åˆ é™¤é€‰æ‹©è®°å½•
async function deleteSelection(id) {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/selections?id=eq.${id}`, {
        method: 'DELETE',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Prefer': 'return=minimal'
        }
      });
      
      if (response.ok) {
        showToast('åˆ é™¤æˆåŠŸ');
        loadSelections(); // é‡æ–°åŠ è½½
      } else {
        const errorText = await response.text();
        throw new Error(`åˆ é™¤å¤±è´¥: ${errorText}`);
      }
      
    } catch (error) {
      console.error('åˆ é™¤å¤±è´¥:', error);
      alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
  }
}

// å¯¼å‡ºæ•°æ®ä¸ºJSONæ–‡ä»¶
async function exportData() {
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/selections?select=*`, {
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`
      }
    });
    
    const selections = await response.json();
    const dataStr = JSON.stringify(selections, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const a = document.createElement('a');
    const date = new Date();
    const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
    a.href = url;
    a.download = `ä»Šå¤©åƒä»€ä¹ˆ-æ•°æ®å¤‡ä»½-${dateStr}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('æ•°æ®å·²å¯¼å‡º');
  } catch (error) {
    console.error('å¯¼å‡ºå¤±è´¥:', error);
    alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
  }
}

// æ¸…ç©ºæ‰€æœ‰è®°å½•
async function clearAllData() {
  if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/selections`, {
        method: 'DELETE',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Prefer': 'return=minimal'
        }
      });
      
      if (response.ok) {
        showToast('æ‰€æœ‰è®°å½•å·²æ¸…ç©º');
        loadSelections();
      } else {
        const errorText = await response.text();
        throw new Error(`æ¸…ç©ºå¤±è´¥: ${errorText}`);
      }
      
    } catch (error) {
      console.error('æ¸…ç©ºå¤±è´¥:', error);
      alert('æ¸…ç©ºå¤±è´¥: ' + error.message);
    }
  }
}

// æ˜¾ç¤ºæç¤º
function showToast(message) {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #27ae60;
    color: white;
    padding: 12px 25px;
    border-radius: 8px;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ==================== äº‹ä»¶ç›‘å¬ ====================
refreshBtn.addEventListener('click', loadSelections);
exportBtn.addEventListener('click', exportData);
clearAllBtn.addEventListener('click', clearAllData);

// ==================== åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', loadSelections);

// æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
setInterval(() => {
  if (!document.hidden) {
    loadSelections();
  }
}, 30000);
</script>
</body>
</html>
