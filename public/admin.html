<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä»Šå¤©åƒä»€ä¹ˆ - åå°æŸ¥çœ‹</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #faf7f2;
  color: #333;
  margin: 0;
  padding: 20px;
}

.container {
  max-width: 1000px;
  margin: 0 auto;
}

.header {
  text-align: center;
  padding: 30px 0;
  background: linear-gradient(135deg, #e67e22, #d35400);
  border-radius: 15px;
  color: white;
  margin-bottom: 30px;
}

.header h1 {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

.controls {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.refresh-btn {
  background: #e67e22;
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 8px;
  font-size: 1.1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
}

.refresh-btn:hover {
  background: #d35400;
}

.stats {
  display: flex;
  gap: 20px;
  margin-top: 20px;
}

.stat-box {
  flex: 1;
  background: #f9f9f9;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
}

.stat-number {
  font-size: 2rem;
  font-weight: bold;
  color: #e67e22;
  display: block;
}

.selection-list {
  display: grid;
  gap: 20px;
}

.selection-card {
  background: white;
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border-left: 5px solid #e67e22;
  transition: transform 0.3s ease;
}

.selection-card:hover {
  transform: translateY(-5px);
}

.user-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 2px solid #f0f0f0;
}

.time-info {
  color: #7f8c8d;
  font-size: 0.9rem;
}

.dishes-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 15px;
}

.dish-tag {
  background: #fff9f0;
  color: #e67e22;
  padding: 8px 15px;
  border-radius: 20px;
  font-weight: 500;
  border: 1px solid #ffecc7;
}

.selection-count {
  font-weight: bold;
  color: #e67e22;
  font-size: 1.2rem;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #7f8c8d;
}

.loading {
  text-align: center;
  padding: 40px;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #e67e22;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.delete-btn {
  background: #ff6b6b;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.9rem;
  margin-top: 10px;
}

.delete-btn:hover {
  background: #ff5252;
}

.export-btn {
  background: #3498db;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.9rem;
  margin-left: 10px;
}

.export-btn:hover {
  background: #2980b9;
}

.clear-btn {
  background: #95a5a6;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.9rem;
  margin-left: 10px;
}

.clear-btn:hover {
  background: #7f8c8d;
}

.action-buttons {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.realtime-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 15px;
}

.toggle-label {
  font-weight: 500;
}

.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #27ae60;
}

input:checked + .slider:before {
  transform: translateX(26px);
}

.back-link {
  display: inline-block;
  margin-top: 20px;
  color: #e67e22;
  text-decoration: none;
  font-weight: 500;
  font-size: 1rem;
  padding: 10px 20px;
  border: 2px solid #e67e22;
  border-radius: 25px;
  transition: all 0.3s ease;
}

.back-link:hover {
  background: rgba(230, 126, 34, 0.1);
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ½ï¸ ä»Šå¤©åƒä»€ä¹ˆ - åå°æŸ¥çœ‹</h1>
    <p>è¿™é‡Œæ˜¯æ‰€æœ‰é€‰æ‹©çš„èœå“è®°å½•</p>
  </div>

  <div class="controls">
    <button class="refresh-btn" id="refreshBtn">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
      </svg>
      åˆ·æ–°æ•°æ®
    </button>
    
    <div class="action-buttons">
      <button class="export-btn" id="exportBtn">å¯¼å‡ºæ•°æ®</button>
      <button class="clear-btn" id="clearAllBtn">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
    </div>
    
    <div class="realtime-toggle">
      <span class="toggle-label">è‡ªåŠ¨åˆ·æ–°ï¼š</span>
      <label class="switch">
        <input type="checkbox" id="autoRefresh" checked>
        <span class="slider"></span>
      </label>
    </div>
    
    <div class="stats" id="stats">
      <!-- ç»Ÿè®¡æ•°æ®ä¼šåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
  </div>

  <div class="selection-list" id="selectionList">
    <!-- é€‰æ‹©è®°å½•ä¼šåŠ¨æ€ç”Ÿæˆ -->
  </div>

  <a href="/" class="back-link">è¿”å›é€‰æ‹©é¡µé¢</a>
</div>

<script>
const loading = document.getElementById('loading');
const selectionList = document.getElementById('selectionList');
const refreshBtn = document.getElementById('refreshBtn');
const stats = document.getElementById('stats');
const exportBtn = document.getElementById('exportBtn');
const clearAllBtn = document.getElementById('clearAllBtn');
const autoRefreshCheckbox = document.getElementById('autoRefresh');

let autoRefreshInterval = null;

// åœ¨é¡¶éƒ¨æ·»åŠ  Supabase é…ç½®
const SUPABASE_URL = 'https://iyisisxptqoaiqprwprx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aXNpc3hwdHFvYWlxcHJ3cHJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODUxNzAsImV4cCI6MjA4MzE2MTE3MH0.NuQYUuKHN7BLtteoxbneBM_RHGvkASvz-HgG0c_ndeI';
// ä¿®æ”¹ loadSelections å‡½æ•°
async function loadSelections() {
  try {
    loading.style.display = 'block';
    selectionList.innerHTML = '';
    
    // ä» Supabase è·å–æ•°æ®ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´é™åºæ’åˆ—
    const response = await fetch(`${SUPABASE_URL}/rest/v1/selections?order=created_at.desc`, {
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`
      }
    });
    
    if (!response.ok) {
      throw new Error(`è·å–æ•°æ®å¤±è´¥: ${response.status}`);
    }
    
    const selections = await response.json();
    
    if (selections.length === 0) {
      selectionList.innerHTML = `
        <div class="empty-state">
          <h3>ğŸ“­ è¿˜æ²¡æœ‰ä»»ä½•æäº¤</h3>
          <p>ç­‰å¾…ç”¨æˆ·æäº¤é€‰æ‹©...</p>
        </div>
      `;
      updateStats(0, 0, 0);
      return;
    }
    
    // è®¡ç®—ä¸åŒè®¾å¤‡æ•°é‡
    const deviceSet = new Set();
    selections.forEach(selection => {
      if (selection.device_id) {
        deviceSet.add(selection.device_id);
      }
    });
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    updateStats(selections.length, selections.reduce((sum, s) => sum + s.dishes.length, 0), deviceSet.size);
    
    // æ˜¾ç¤ºæ‰€æœ‰é€‰æ‹©
    selections.forEach((selection, index) => {
      const deviceName = selection.device_id ? 
        `è®¾å¤‡: ${selection.device_id.substring(0, 10)}...` : 
        'æœªçŸ¥è®¾å¤‡';
      
      const card = document.createElement('div');
      card.className = 'selection-card';
      card.innerHTML = `
        <div class="user-info">
          <div class="user-name">${deviceName}</div>
          <div class="submit-time">ğŸ• ${selection.submit_time || selection.created_at}</div>
        </div>
        
        <div class="dishes-list">
          ${selection.dishes.map(dish => 
            `<span class="dish-tag">${dish.name}${dish.category ? ` (${dish.category})` : ''}</span>`
          ).join('')}
        </div>
        
        <div>
          <strong>æ€»è®¡ï¼š<span class="selection-count">${selection.dishes.length}</span> ä¸ªèœå“</strong>
        </div>
        
        <button class="delete-btn" onclick="deleteSelection('${selection.id}')">åˆ é™¤è¿™æ¡è®°å½•</button>
      `;
      
      selectionList.appendChild(card);
    });
    
  } catch (error) {
    console.error('åŠ è½½å¤±è´¥:', error);
    selectionList.innerHTML = `
      <div class="error" style="background: #fdedec; padding: 30px; border-radius: 10px; text-align: center;">
        <h3 style="color: #e74c3c;">âŒ åŠ è½½å¤±è´¥</h3>
        <p>${error.message}</p>
        <button class="secondary-btn" onclick="loadSelections()" style="margin-top: 15px;">é‡æ–°åŠ è½½</button>
      </div>
    `;
  } finally {
    loading.style.display = 'none';
  }
}

// æ›´æ–°ç»Ÿè®¡æ•°æ®å‡½æ•°
function updateStats(totalSelections, totalDishes, totalDevices) {
  stats.innerHTML = `
    <div class="stat-box">
      <span class="stat-number">${totalSelections}</span>
      <span>æ€»é€‰æ‹©æ¬¡æ•°</span>
    </div>
    <div class="stat-box">
      <span class="stat-number">${totalDishes}</span>
      <span>æ€»èœå“æ•°é‡</span>
    </div>
    <div class="stat-box">
      <span class="stat-number">${totalDevices}</span>
      <span>ä¸åŒè®¾å¤‡æ•°é‡</span>
    </div>
  `;
}

// ä¿®æ”¹åˆ é™¤å‡½æ•°
async function deleteSelection(id) {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/selections?id=eq.${id}`, {
        method: 'DELETE',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Prefer': 'return=minimal'
        }
      });
      
      if (response.ok) {
        showToast('åˆ é™¤æˆåŠŸ');
        loadSelections(); // é‡æ–°åŠ è½½
      } else {
        throw new Error('åˆ é™¤å¤±è´¥');
      }
      
    } catch (error) {
      console.error('åˆ é™¤å¤±è´¥:', error);
      alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
  }
}

// ä¿®æ”¹å¯¼å‡ºå‡½æ•°
async function exportData() {
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/selections?select=*`, {
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`
      }
    });
    
    const selections = await response.json();
    const dataStr = JSON.stringify(selections, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const a = document.createElement('a');
    const date = new Date();
    const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
    a.href = url;
    a.download = `ä»Šå¤©åƒä»€ä¹ˆ-æ•°æ®å¤‡ä»½-${dateStr}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('æ•°æ®å·²å¯¼å‡º');
  } catch (error) {
    console.error('å¯¼å‡ºå¤±è´¥:', error);
    alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
  }
}

// ä¿®æ”¹æ¸…ç©ºæ‰€æœ‰è®°å½•å‡½æ•°
async function clearAllData() {
  if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/selections`, {
        method: 'DELETE',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Prefer': 'return=minimal'
        }
      });
      
      if (response.ok) {
        showToast('æ‰€æœ‰è®°å½•å·²æ¸…ç©º');
        loadSelections();
      } else {
        throw new Error('æ¸…ç©ºå¤±è´¥');
      }
      
    } catch (error) {
      console.error('æ¸…ç©ºå¤±è´¥:', error);
      alert('æ¸…ç©ºå¤±è´¥: ' + error.message);
    }
  }
}

// å¯¼å‡ºæ•°æ®ä¸ºJSONæ–‡ä»¶
function exportData() {
  try {
    const selections = JSON.parse(localStorage.getItem('foodSelections') || '[]');
    const dataStr = JSON.stringify(selections, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const a = document.createElement('a');
    const date = new Date();
    const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
    a.href = url;
    a.download = `ä»Šå¤©åƒä»€ä¹ˆ-æ•°æ®å¤‡ä»½-${dateStr}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('æ•°æ®å·²å¯¼å‡º');
  } catch (error) {
    console.error('å¯¼å‡ºå¤±è´¥:', error);
    alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
  }
}

// æ¸…ç©ºæ‰€æœ‰è®°å½•
function clearAllData() {
  if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
    try {
      localStorage.removeItem('foodSelections');
      showToast('æ‰€æœ‰è®°å½•å·²æ¸…ç©º');
      loadSelections();
    } catch (error) {
      console.error('æ¸…ç©ºå¤±è´¥:', error);
      alert('æ¸…ç©ºå¤±è´¥: ' + error.message);
    }
  }
}

// æ˜¾ç¤ºæç¤º
function showToast(message) {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #27ae60;
    color: white;
    padding: 12px 25px;
    border-radius: 8px;
    z-index: 1000;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// è‡ªåŠ¨åˆ·æ–°æ§åˆ¶
function toggleAutoRefresh() {
  if (autoRefreshCheckbox.checked) {
    startAutoRefresh();
  } else {
    stopAutoRefresh();
  }
}

function startAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
  }
  autoRefreshInterval = setInterval(loadSelections, 10000); // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡
}

function stopAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = null;
  }
}

// äº‹ä»¶ç›‘å¬
refreshBtn.addEventListener('click', loadSelections);
exportBtn.addEventListener('click', exportData);
clearAllBtn.addEventListener('click', clearAllData);
autoRefreshCheckbox.addEventListener('change', toggleAutoRefresh);

// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
  loadSelections();
  
  // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
  if (autoRefreshCheckbox.checked) {
    startAutoRefresh();
  }
});

// é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤„ç†è‡ªåŠ¨åˆ·æ–°
document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    stopAutoRefresh();
  } else if (autoRefreshCheckbox.checked) {
    startAutoRefresh();
  }
});
</script>
</body>
</html>
